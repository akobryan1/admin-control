<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Final Exam Results Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Kill cache during development -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="version" content="build-KZ-collectionGroup-1">

  <style>
    :root {
      --bg: #020617;
      --border-soft: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --danger: #f87171;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #020617;
      color: var(--text);
    }

    .page {
      max-width: 1100px;
      margin: auto;
      padding: 24px;
    }

    h1 { margin-bottom: 6px; }

    .subtitle {
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .search-wrap {
      position: relative;
      flex: 1;
      max-width: 420px;
    }

    .search-wrap input {
      width: 100%;
      padding: 9px 32px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #0f172a;
      color: var(--text);
    }

    .pill-info {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: #0f172a;
    }

    .card {
      border-radius: 16px;
      padding: 16px;
      background: #0f172a;
      border: 1px solid #1e293b;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: var(--muted);
      font-size: 0.85rem;
      gap: 12px;
      flex-wrap: wrap;
    }

    #statusText span.dot {
      width: 7px;
      height: 7px;
      background: var(--accent);
      border-radius: 999px;
      display: inline-block;
      margin-right: 6px;
    }

    details.course-block,
    details.section-block {
      border: 1px solid #334155;
      border-radius: 10px;
      margin-bottom: 10px;
      background: #0f172a;
    }

    details > summary {
      cursor: pointer;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-title {
      font-weight: 600;
    }

    .summary-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-left: 8px;
    }

    .section-inner {
      padding: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #1e293b;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #1e293b44;
    }

    tbody tr:hover {
      background: #1e40af55;
    }

    .download-btn {
      padding: 4px 10px;
      font-size: 0.78rem;
      border: 1px solid var(--accent);
      background: #0f172a;
      color: #e0f2fe;
      border-radius: 999px;
      cursor: pointer;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Final Exam Submissions</h1>
  <div class="subtitle">
    Loaded via <code>collectionGroup("attempts")</code> filtered to
    <code>finals-exam / KzRzubb5df1TV1gL2RuF / submissions / … / attempts / attempt*</code>,
    grouped by <strong>Course</strong> &amp; <strong>Section</strong>.
  </div>

  <div class="toolbar">
    <div class="search-wrap">
      <input id="searchInput" placeholder="Search by name, course, section…" />
    </div>
    <div class="pill-info">
      Loaded rows: <strong id="rowCount">0</strong>
    </div>
  </div>

  <div class="card">
    <div class="status-bar">
      <div id="statusText"><span class="dot"></span>Connecting…</div>
      <div id="lastUpdated">Last updated: —</div>
    </div>

    <div id="dataContainer" class="accordion"></div>
  </div>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collectionGroup,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  console.log("[DEBUG] Script running with collectionGroup…");

  const firebaseConfig = {
    apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
    authDomain: "kuya-quiz-100.firebaseapp.com",
    projectId: "kuya-quiz-100",
    storageBucket: "kuya-quiz-100.firebasestorage.app",
    messagingSenderId: "74623975270",
    appId: "1:74623975270:web:dec2b21dbee017292952a7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  console.log("[DEBUG] Firebase initialized");

  // We only want attempts under this parent doc
  const COURSE_PARENT = "KzRzubb5df1TV1gL2RuF";

  const dataContainer = document.getElementById("dataContainer");
  const rowCountEl = document.getElementById("rowCount");
  const statusText = document.getElementById("statusText");
  const lastUpdatedEl = document.getElementById("lastUpdated");
  const searchInput = document.getElementById("searchInput");

  let allRows = [];

  function setStatus(msg, error = false) {
    statusText.innerHTML = `<span class="dot"></span>${msg}`;
    statusText.style.color = error ? "#f87171" : "#9ca3af";
    console.log("[STATUS]", msg);
  }

  function sanitize(str) {
    return (str || "").toLowerCase();
  }

  function normalizeCourse(raw) {
    if (!raw) return "Unknown Course";
    const s = raw.toLowerCase().trim();

    if (s.includes("crop") && s.includes("sci")) {
      return "CropSci Final Exam";
    }
    if (s.includes("agricultural biotechnology") || s.includes("biotech")) {
      return "Agricultural Biotechnology Final Exam";
    }
    return raw;
  }

  function formatTimestamp(date) {
    const d = date ?? new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    const h = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${da} ${h}:${mi}`;
  }

  function buildPDF(rec) {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("PDF library (jsPDF) not loaded.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 15;

    doc.setFontSize(14);
    doc.text("Final Exam Answer Sheet", 10, y);
    y += 10;

    doc.setFontSize(11);
    doc.text("Name: " + (rec.name || ""), 10, y); y += 6;
    doc.text("Course: " + (rec.course || ""), 10, y); y += 6;
    doc.text("Section: " + (rec.section || "—"), 10, y); y += 6;
    doc.text("Score: " + (rec.score ?? ""), 10, y); y += 10;

    doc.text("Answers:", 10, y); y += 6;

    const answers = Array.isArray(rec.attemptData.answers)
      ? rec.attemptData.answers
      : [];

    answers.forEach((ans, i) => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      const chosen = ans.chosenAnswer ?? ans.chosen ?? "";
      const correct = ans.correctAnswer ?? ans.correct ?? "";
      const line = `${i + 1}. Chosen: ${chosen} | Correct: ${correct}`;
      doc.text(line, 10, y);
      y += 6;
    });

    const safeName = (rec.name || "student").replace(/[^a-z0-9]/gi, "_");
    doc.save(`${safeName}_answers.pdf`);
  }

  async function loadData() {
    try {
      setStatus("Loading from Firestore (collectionGroup: attempts)…");

      // Get ALL attempts across DB
      const attemptsRef = collectionGroup(db, "attempts");
      const attemptsSnap = await getDocs(attemptsRef);
      console.log("[DEBUG] collectionGroup(attempts) count:", attemptsSnap.size);

      const records = [];

      attemptsSnap.forEach(docSnap => {
        const path = docSnap.ref.path;
        // Expecting: finals-exam/{COURSE_PARENT}/submissions/{student}/attempts/{attemptId}
        // Example: finals-exam/KzRzubb5df1TV1gL2RuF/submissions/.../attempts/attempt1
        if (!path.startsWith(`finals-exam/${COURSE_PARENT}/submissions/`)) {
          return; // skip other exams (e.g., ANSCI container)
        }

        const pathParts = path.split("/");
        // [0]=finals-exam, [1]=KzRzubb..., [2]=submissions, [3]=studentId, [4]=attempts, [5]=attemptId
        if (pathParts.length !== 6) return;
        if (pathParts[4] !== "attempts") return;

        const attemptId = pathParts[5];
        // We only care about attempt docs (id may be "attempt1", "attempt2", etc.)
        if (!attemptId.toLowerCase().includes("attempt")) {
          return;
        }

        const data = docSnap.data() || {};

        const rawCourse =
          data.Course ??
          data.course ??
          data.CourseName ??
          data.courseName ??
          "Unknown Course";

        const name =
          data.Name ??
          data.name ??
          data.StudentName ??
          data.studentName ??
          "Unknown";

        const section =
          data.Section ??
          data.section ??
          data.SectionUsed ??
          data.sectionUsed ??
          "—";

        const scoreVal = data.Score ?? data.score ?? data.TotalScore ?? data.totalScore;
        const score = parseFloat(scoreVal ?? "0") || 0;

        const normalizedCourse = normalizeCourse(rawCourse);

        // Only keep the two finals we care about
        if (
          normalizedCourse !== "CropSci Final Exam" &&
          normalizedCourse !== "Agricultural Biotechnology Final Exam"
        ) {
          return;
        }

        records.push({
          name,
          course: normalizedCourse,
          section,
          score,
          attemptData: data,
          path
        });
      });

      console.log("[DEBUG] total records collected after filtering:", records.length);

      if (!records.length) {
        setStatus("No matching records found.");
        dataContainer.innerHTML =
          '<div style="padding:10px;font-size:0.9rem;color:#9ca3af;">No submissions to display.</div>';
        return;
      }

      buildUI(records);
      setStatus("Data loaded.");
      lastUpdatedEl.textContent = "Last updated: " + formatTimestamp();
    } catch (err) {
      console.error("[ERROR] loadData:", err);
      setStatus("Error: " + err.message, true);
    }
  }

  function groupData(records) {
    const map = {};
    for (const r of records) {
      if (!map[r.course]) map[r.course] = {};
      const sectionKey = r.section || "—";
      if (!map[r.course][sectionKey]) map[r.course][sectionKey] = [];
      map[r.course][sectionKey].push(r);
    }
    return map;
  }

  function buildUI(records) {
    const grouped = groupData(records);
    allRows = [];
    dataContainer.innerHTML = "";

    const courseList = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

    courseList.forEach(course => {
      const courseBlock = document.createElement("details");
      courseBlock.className = "course-block";

      const sectionsMap = grouped[course];
      const totalInCourse = Object.values(sectionsMap).reduce(
        (sum, arr) => sum + arr.length,
        0
      );

      const summary = document.createElement("summary");
      summary.innerHTML = `
        <div>
          <span class="summary-title">${course}</span>
          <span class="summary-meta">
            Sections: ${Object.keys(sectionsMap).length} • Records: ${totalInCourse}
          </span>
        </div>
      `;
      courseBlock.appendChild(summary);

      const sectionAccordion = document.createElement("div");

      const sections = Object.keys(sectionsMap).sort((a, b) =>
        a.localeCompare(b)
      );

      sections.forEach(section => {
        const sectionBlock = document.createElement("details");
        sectionBlock.className = "section-block";

        const label = section === "—" ? "No Section" : section;

        const ssum = document.createElement("summary");
        ssum.innerHTML = `
          <div>
            <span class="summary-title">Section ${label}</span>
            <span class="summary-meta">Records: ${sectionsMap[section].length}</span>
          </div>
        `;
        sectionBlock.appendChild(ssum);

        const inner = document.createElement("div");
        inner.className = "section-inner";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Course</th>
              <th>Section</th>
              <th>Score</th>
              <th>Actions</th>
            </tr>
          </thead>
        `;
        const tbody = document.createElement("tbody");

        sectionsMap[section].forEach(rec => {
          const tr = document.createElement("tr");
          tr.dataset.name = sanitize(rec.name);
          tr.dataset.course = sanitize(rec.course);
          tr.dataset.section = sanitize(rec.section);

          tr.innerHTML = `
            <td>${rec.name}</td>
            <td>${rec.course}</td>
            <td>${rec.section}</td>
            <td>${rec.score}</td>
            <td><button class="download-btn">Download PDF</button></td>
          `;

          tr.querySelector("button").onclick = () => buildPDF(rec);

          tbody.appendChild(tr);
          allRows.push(tr);
        });

        table.appendChild(tbody);
        inner.appendChild(table);
        sectionBlock.appendChild(inner);
        sectionAccordion.appendChild(sectionBlock);
      });

      courseBlock.appendChild(sectionAccordion);
      dataContainer.appendChild(courseBlock);
    });

    rowCountEl.textContent = allRows.length.toString();
  }

  searchInput.addEventListener("input", e => {
    const q = sanitize(e.target.value);
    allRows.forEach(tr => {
      const hay =
        tr.dataset.name +
        " " +
        tr.dataset.course +
        " " +
        tr.dataset.section;
      tr.classList.toggle("hidden", !hay.includes(q));
    });
  });

  loadData();
</script>
</body>
</html>
