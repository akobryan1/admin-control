<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Final Exam Results Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Kill cache during development -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="version" content="build-KZ-fullfix-final-1">

  <style>
    :root {
      --bg: #020617;
      --border-soft: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --danger: #f87171;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #020617;
      color: var(--text);
    }

    .page {
      max-width: 1100px;
      margin: auto;
      padding: 24px;
    }

    h1 { margin-bottom: 6px; }

    .subtitle {
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    .search-wrap {
      position: relative;
      flex: 1;
      max-width: 420px;
    }

    .search-wrap input {
      width: 100%;
      padding: 9px 32px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #0f172a;
      color: var(--text);
    }

    .pill-info {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: #0f172a;
    }

    .card {
      border-radius: 16px;
      padding: 16px;
      background: #0f172a;
      border: 1px solid #1e293b;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    #statusText span.dot {
      width: 7px; height: 7px;
      background: var(--accent);
      border-radius: 999px;
      display: inline-block;
      margin-right: 6px;
    }

    details.course-block, details.section-block {
      border: 1px solid #334155;
      border-radius: 10px;
      margin-bottom: 10px;
      background: #0f172a;
    }

    details > summary {
      cursor: pointer;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
    }

    .section-inner {
      padding: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #1e293b;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) { background: #1e293b44; }
    tbody tr:hover { background: #1e40af55; }

    .download-btn {
      padding: 4px 10px;
      font-size: 0.78rem;
      border: 1px solid var(--accent);
      background: #0f172a;
      color: #e0f2fe;
      border-radius: 999px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Final Exam Submissions</h1>
  <div class="subtitle">
    Loading from <code>finals-exam / KzRzubb5df1TV1gL2RuF / submissions</code>, grouped by Course & Section
  </div>

  <div class="toolbar">
    <div class="search-wrap">
      <input id="searchInput" placeholder="Search by name, course, section…" />
    </div>
    <div class="pill-info">
      Loaded rows: <strong id="rowCount">0</strong>
    </div>
  </div>

  <div class="card">
    <div class="status-bar">
      <div id="statusText"><span class="dot"></span>Connecting…</div>
      <div id="lastUpdated">Last updated: —</div>
    </div>

    <div id="dataContainer" class="accordion"></div>
  </div>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  console.log("[DEBUG] Script running…");

  const firebaseConfig = {
    apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
    authDomain: "kuya-quiz-100.firebaseapp.com",
    projectId: "kuya-quiz-100",
    storageBucket: "kuya-quiz-100.firebasestorage.app",
    messagingSenderId: "74623975270",
    appId: "1:74623975270:web:dec2b21dbee017292952a7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  console.log("[DEBUG] Firebase initialized");

  const COURSE_PARENT = "KzRzubb5df1TV1gL2RuF";
  const dataContainer = document.getElementById("dataContainer");
  const rowCountEl = document.getElementById("rowCount");
  const statusText = document.getElementById("statusText");

  let allRows = [];

  function setStatus(msg, error=false) {
    statusText.innerHTML = `<span class="dot"></span>${msg}`;
    if (error) statusText.style.color = "#f87171";
  }

  function sanitize(str) {
    return (str || "").toLowerCase();
  }

  function normalizeCourse(raw) {
    if (!raw) return "Unknown Course";
    const s = raw.toLowerCase();

    if (s.includes("crop") && s.includes("sci")) return "CropSci Final Exam";
    if (s.includes("biotech") || s.includes("biotechnology")) return "Agricultural Biotechnology Final Exam";

    return raw;
  }

  function buildPDF(rec) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 15;

    doc.setFontSize(14);
    doc.text("Final Exam Answer Sheet", 10, y);
    y += 10;

    doc.setFontSize(11);
    doc.text("Name: " + rec.name, 10, y); y+=6;
    doc.text("Course: " + rec.course, 10, y); y+=6;
    doc.text("Section: " + rec.section, 10, y); y+=6;
    doc.text("Score: " + rec.score, 10, y); y+=10;

    doc.text("Answers:", 10, y); y+=6;

    if (rec.attemptData.answers) {
      rec.attemptData.answers.forEach((ans,i)=>{
        if (y > 280) { doc.addPage(); y = 20; }
        const line = `${i+1}. Chosen: ${ans.chosenAnswer||""} | Correct: ${ans.correctAnswer||""}`;
        doc.text(line, 10, y);
        y+=6;
      });
    }

    doc.save(rec.name.replace(/[^a-z0-9]/gi,"_") + "_answers.pdf");
  }

  async function loadData() {
    try {
      setStatus("Loading…");

      const submissionsRef = collection(db, "finals-exam", COURSE_PARENT, "submissions");
      const submissionsSnap = await getDocs(submissionsRef);

      const records = [];

      for (const docSnap of submissionsSnap.docs) {
        const attemptsRef = collection(
          db,
          "finals-exam",
          COURSE_PARENT,
          "submissions",
          docSnap.id,
          "attempts"
        );
        const attemptsSnap = await getDocs(attemptsRef);

        if (attemptsSnap.empty) continue;

        const attemptDoc =
          attemptsSnap.docs.find(d => d.id === "attempt1") ||
          attemptsSnap.docs.find(d => d.id.toLowerCase().includes("attempt")) ||
          attemptsSnap.docs[0];


        const attempt = attemptDoc.data() || {};
        const submissionMeta = docSnap.data() || {};

        // FIX: fallback to submission-level metadata
        const rawCourse =
          attempt.Course ??
          attempt.course ??
          submissionMeta.CourseUsed ??
          submissionMeta.courseUsed ??
          attempt.CourseName ??
          "Unknown Course";

        const name =
          attempt.Name ??
          submissionMeta.Name ??
          "Unknown";

        const section =
          attempt.Section ??
          submissionMeta.Section ??
          submissionMeta.SectionUsed ??
          "—";

        const score = parseFloat(attempt.Score ?? submissionMeta.Score ?? "0") || 0;

        records.push({
          name,
          course: normalizeCourse(rawCourse),
          section,
          score,
          attemptData: attempt
        });
      }

      console.log("[DEBUG] total collected:", records.length);
      buildUI(records);
      setStatus("Data loaded.");
    }
    catch (err) {
      console.error(err);
      setStatus("Error: " + err.message, true);
    }
  }

  function groupData(records) {
    const map = {};
    for (const r of records) {
      if (!map[r.course]) map[r.course] = {};
      if (!map[r.course][r.section]) map[r.course][r.section] = [];
      map[r.course][r.section].push(r);
    }
    return map;
  }

  function buildUI(records) {
    const grouped = groupData(records);
    allRows = [];
    dataContainer.innerHTML = "";

    const courseList = Object.keys(grouped).sort();

    for (const course of courseList) {
      const courseBlock = document.createElement("details");
      courseBlock.className = "course-block";

      const summary = document.createElement("summary");
      summary.innerHTML = `<div>${course}</div>`;
      courseBlock.appendChild(summary);

      const sectionAccordion = document.createElement("div");

      const sections = Object.keys(grouped[course]).sort();

      for (const section of sections) {
        const sectionBlock = document.createElement("details");
        sectionBlock.className = "section-block";

        const ssum = document.createElement("summary");
        ssum.innerHTML = `<div>Section ${section}</div>`;
        sectionBlock.appendChild(ssum);

        const inner = document.createElement("div");
        inner.className = "section-inner";

        // Table
        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Course</th>
              <th>Section</th>
              <th>Score</th>
              <th>Actions</th>
            </tr>
          </thead>
        `;
        const tbody = document.createElement("tbody");

        grouped[course][section].forEach(rec => {
          const tr = document.createElement("tr");
          tr.dataset.name = sanitize(rec.name);
          tr.dataset.course = sanitize(rec.course);
          tr.dataset.section = sanitize(rec.section);

          tr.innerHTML = `
            <td>${rec.name}</td>
            <td>${rec.course}</td>
            <td>${rec.section}</td>
            <td>${rec.score}</td>
            <td><button class="download-btn">Download PDF</button></td>
          `;

          tr.querySelector("button").onclick = () => buildPDF(rec);

          tbody.appendChild(tr);
          allRows.push(tr);
        });

        table.appendChild(tbody);
        inner.appendChild(table);
        sectionBlock.appendChild(inner);
        sectionAccordion.appendChild(sectionBlock);
      }

      courseBlock.appendChild(sectionAccordion);
      dataContainer.appendChild(courseBlock);
    }

    rowCountEl.textContent = allRows.length;
  }

  document.getElementById("searchInput").addEventListener("input", (e)=>{
    const q = sanitize(e.target.value);
    allRows.forEach(tr => {
      const hay =
        tr.dataset.name + " " +
        tr.dataset.course + " " +
        tr.dataset.section;
      tr.classList.toggle("hidden", !hay.includes(q));
    });
  });

  loadData();
</script>

</body>
</html>
