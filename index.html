<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Final Exam Results Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="version" content="build-KZ-collectionGroup-final-1">

  <style>
    :root {
      --bg: #020617;
      --border-soft: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --danger: #f87171;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 55%);
      color: var(--text);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 18px 40px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.6rem;
    }

    .subtitle {
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .subtitle code {
      background: rgba(15, 23, 42, 0.9);
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(30, 64, 175, 0.4);
      font-size: 0.8rem;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .search-wrap {
      position: relative;
      flex: 1;
      max-width: 420px;
    }

    .search-wrap input {
      width: 100%;
      padding: 9px 32px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.25) 0, rgba(15, 23, 42, 0.95) 55%);
      color: var(--text);
      outline: none;
      font-size: 0.9rem;
    }

    .search-wrap input::placeholder {
      color: #64748b;
    }

    .search-wrap::before {
      content: "ðŸ”";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .pill-info {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: rgba(15, 23, 42, 0.95);
      white-space: nowrap;
    }

    .card {
      border-radius: 16px;
      padding: 16px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 60%),
        radial-gradient(circle at bottom right, rgba(37, 99, 235, 0.25), #020617 70%);
      border: 1px solid #1e293b;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: var(--muted);
      font-size: 0.85rem;
      gap: 8px;
      flex-wrap: wrap;
    }

    #statusText span.dot {
      width: 7px;
      height: 7px;
      background: var(--accent);
      border-radius: 999px;
      display: inline-block;
      margin-right: 6px;
      box-shadow: 0 0 6px rgba(45, 212, 191, 0.9);
    }

    #statusText.error span.dot {
      background: var(--danger);
      box-shadow: 0 0 6px rgba(248, 113, 113, 0.9);
    }

    details.course-block,
    details.section-block {
      border: 1px solid #334155;
      border-radius: 10px;
      margin-bottom: 10px;
      background: rgba(15, 23, 42, 0.95);
      overflow: hidden;
    }

    details > summary {
      cursor: pointer;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      list-style: none;
      user-select: none;
    }

    details > summary::-webkit-details-marker {
      display: none;
    }

    .summary-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .summary-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-left: 6px;
    }

    .summary-chevron {
      font-size: 0.8rem;
      color: #64748b;
      margin-left: 6px;
      transition: transform 0.16s ease;
    }

    details[open] > summary .summary-chevron {
      transform: rotate(90deg);
      color: #e5e7eb;
    }

    .section-inner {
      padding: 10px 12px 12px;
      border-top: 1px solid #020617;
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 60%);
    }

    .section-caption {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .table-wrap {
      border-radius: 10px;
      border: 1px solid #1f2937;
      overflow-x: auto;
      background: rgba(15, 23, 42, 0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
      min-width: 520px;
    }

    thead {
      background: linear-gradient(to right, rgba(15, 23, 42, 0.98), #020617);
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #1e293b;
      white-space: nowrap;
      text-align: left;
    }

    th {
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.82);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.62);
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, 0.4);
    }

    .download-btn {
      padding: 4px 10px;
      font-size: 0.78rem;
      border: 1px solid var(--accent);
      background: #020617;
      color: #e0f2fe;
      border-radius: 999px;
      cursor: pointer;
      white-space: nowrap;
    }

    .download-btn:hover {
      background: rgba(56, 189, 248, 0.16);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 1.3rem;
      }
      .card {
        padding: 14px 12px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Final Exam Submissions</h1>
  <div class="subtitle">
    Loading all <code>attempts/attempt1</code> under
    <code>finals-exam / KzRzubb5df1TV1gL2RuF / submissions</code>,
    grouped by <strong>Course</strong> &amp; <strong>Section</strong>.
  </div>

  <div class="toolbar">
    <div class="search-wrap">
      <input id="searchInput" placeholder="Search by name, course, sectionâ€¦" autocomplete="off" />
    </div>
    <div class="pill-info">
      Loaded rows: <strong id="rowCount">0</strong>
    </div>
  </div>

  <div class="card">
    <div class="status-bar">
      <div id="statusText"><span class="dot"></span><span>Connectingâ€¦</span></div>
      <div id="lastUpdated">Last updated: â€”</div>
    </div>
    <div id="dataContainer" class="accordion"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collectionGroup,
    getDocs,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
    authDomain: "kuya-quiz-100.firebaseapp.com",
    projectId: "kuya-quiz-100",
    storageBucket: "kuya-quiz-100.firebasestorage.app",
    messagingSenderId: "74623975270",
    appId: "1:74623975270:web:dec2b21dbee017292952a7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const EXAM_PARENT_ID = "KzRzubb5df1TV1gL2RuF";

  const dataContainer = document.getElementById("dataContainer");
  const rowCountEl = document.getElementById("rowCount");
  const statusText = document.getElementById("statusText");
  const lastUpdatedEl = document.getElementById("lastUpdated");
  const searchInput = document.getElementById("searchInput");

  let allRows = [];

  function setStatus(msg, error = false) {
    statusText.classList.toggle("error", error);
    statusText.innerHTML = `<span class="dot"></span><span>${msg}</span>`;
    console.log("[STATUS]", msg);
  }

  function sanitize(str) {
    return (str || "").toLowerCase();
  }

  function normalizeCourse(raw) {
    if (!raw) return "Unknown Course";
    const s = raw.toLowerCase();
    if (s.includes("crop") && s.includes("sci")) return "CropSci Final Exam";
    if (s.includes("biotech") || s.includes("biotechnology")) {
      return "Agricultural Biotechnology Final Exam";
    }
    return raw;
  }

  function formatTimestamp(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const h = String(d.getHours()).padStart(2, "0");
    const min = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${h}:${min}`;
  }

  function buildPDF(rec) {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("PDF library not loaded.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 15;

    doc.setFontSize(14);
    doc.text("Final Exam Answer Sheet", 10, y);
    y += 10;

    doc.setFontSize(11);
    doc.text("Name: " + (rec.name || "â€”"), 10, y); y += 6;
    doc.text("Course: " + (rec.course || "â€”"), 10, y); y += 6;
    doc.text("Section: " + (rec.section || "â€”"), 10, y); y += 6;
    doc.text("Score: " + (rec.score ?? "â€”"), 10, y); y += 10;

    doc.text("Answers:", 10, y); y += 6;

    const answers = Array.isArray(rec.attemptData.answers)
      ? rec.attemptData.answers
      : [];

    answers.forEach((ans, i) => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      const chosen = ans.chosenAnswer ?? ans.chosen ?? "";
      const correct = ans.correctAnswer ?? ans.correct ?? "";
      const mark = ans.isCorrect === true ? "âœ”" : (ans.isCorrect === false ? "âœ˜" : "");
      const line = `${String(i + 1).padStart(2, "0")}. Chosen: ${chosen} | Correct: ${correct} ${mark}`;
      doc.text(line, 10, y);
      y += 6;
    });

    const safeName = (rec.name || "student").toString()
      .replace(/[^a-z0-9]+/gi, "_")
      .replace(/^_+|_+$/g, "")
      .toLowerCase();

    const safeCourse = (rec.course || "course").toString()
      .replace(/[^a-z0-9]+/gi, "_")
      .replace(/^_+|_+$/g, "")
      .toLowerCase();

    doc.save(`${safeName}_${safeCourse}_answers.pdf`);
  }

  async function loadData() {
    try {
      setStatus("Loading data from Firestoreâ€¦");

      const attemptsQuery = collectionGroup(db, "attempts");
      const attemptsSnap = await getDocs(attemptsQuery);
      console.log("[DEBUG] total attempts docs in group:", attemptsSnap.size);

      const records = [];

      for (const docSnap of attemptsSnap.docs) {
        const path = docSnap.ref.path || "";
        }

        if (docSnap.id !== "attempt1") {
          continue;
        }

        const attempt = docSnap.data() || {};
        let submissionMeta = {};

        try {
          const submissionRef = docSnap.ref.parent.parent;
          if (submissionRef) {
            const submissionSnap = await getDoc(submissionRef);
            if (submissionSnap.exists()) {
              submissionMeta = submissionSnap.data() || {};
            }
          }
        } catch (e) {
          console.warn("[WARN] Failed to read submission meta for", path, e);
        }

        const rawCourse =
          attempt.Course ??
          attempt.course ??
          submissionMeta.Course ??
          submissionMeta.CourseUsed ??
          submissionMeta.courseUsed ??
          attempt.CourseName ??
          "Unknown Course";

        const name =
          attempt.Name ??
          attempt.name ??
          submissionMeta.Name ??
          "Unknown";

        const section =
          attempt.Section ??
          attempt.section ??
          submissionMeta.Section ??
          submissionMeta.section ??
          submissionMeta.SectionUsed ??
          "â€”";

        const scoreVal =
          attempt.Score ??
          attempt.score ??
          submissionMeta.Score ??
          submissionMeta.LatestScore;

        const score =
          typeof scoreVal === "number"
            ? scoreVal
            : parseFloat(scoreVal ?? "0") || 0;

        records.push({
          name,
          course: normalizeCourse(rawCourse),
          section,
          score,
          attemptData: attempt
        });
      }

      console.log("[DEBUG] total collected for this exam:", records.length);

      if (!records.length) {
        dataContainer.innerHTML =
          '<div style="padding:8px 4px;font-size:0.9rem;color:#9ca3af;">No submissions found for this exam.</div>';
        setStatus("No data found.");
        rowCountEl.textContent = "0";
        return;
      }

      buildUI(records);
      setStatus("Data loaded.");
      lastUpdatedEl.textContent = "Last updated: " + formatTimestamp();
    } catch (err) {
      console.error(err);
      setStatus("Error: " + err.message, true);
    }
  }

  function groupData(records) {
    const map = {};
    for (const r of records) {
      if (!map[r.course]) map[r.course] = {};
      const sectionKey = r.section || "â€”";
      if (!map[r.course][sectionKey]) map[r.course][sectionKey] = [];
      map[r.course][sectionKey].push(r);
    }
    return map;
  }

  function buildUI(records) {
    const grouped = groupData(records);
    allRows = [];
    dataContainer.innerHTML = "";

    const courseList = Object.keys(grouped).sort((a, b) =>
      a.localeCompare(b)
    );

    courseList.forEach((course) => {
      const sectionsForCourse = grouped[course];
      const totalRecords = Object.values(sectionsForCourse)
        .reduce((sum, arr) => sum + arr.length, 0);

      const courseBlock = document.createElement("details");
      courseBlock.className = "course-block";

      const summary = document.createElement("summary");
      summary.innerHTML = `
        <div>
          <span class="summary-label">${course}</span>
          <span class="summary-meta">Sections: ${
            Object.keys(sectionsForCourse).length
          } â€¢ Records: ${totalRecords}</span>
        </div>
        <span class="summary-chevron">â–¶</span>
      `;
      courseBlock.appendChild(summary);

      const sectionAccordion = document.createElement("div");

      const sections = Object.keys(sectionsForCourse).sort((a, b) =>
        a.localeCompare(b)
      );

      sections.forEach((sectionKey) => {
        const rows = sectionsForCourse[sectionKey];

        const sectionBlock = document.createElement("details");
        sectionBlock.className = "section-block";

        const ssum = document.createElement("summary");
        const label = sectionKey === "â€”" ? "No Section" : sectionKey;
        ssum.innerHTML = `
          <div>
            <span class="summary-label">Section ${label}</span>
            <span class="summary-meta">Records: ${rows.length}</span>
          </div>
          <span class="summary-chevron">â–¶</span>
        `;
        sectionBlock.appendChild(ssum);

        const inner = document.createElement("div");
        inner.className = "section-inner";
        inner.innerHTML =
          '<div class="section-caption">Use the search bar above to filter by name, course, or section.</div>';

        const tableWrap = document.createElement("div");
        tableWrap.className = "table-wrap";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Course</th>
              <th>Section</th>
              <th>Score</th>
              <th>Actions</th>
            </tr>
          </thead>
        `;

        const tbody = document.createElement("tbody");

        rows.forEach((rec) => {
          const tr = document.createElement("tr");
          tr.dataset.name = sanitize(rec.name);
          tr.dataset.course = sanitize(rec.course);
          tr.dataset.section = sanitize(rec.section);

          tr.innerHTML = `
            <td>${rec.name}</td>
            <td>${rec.course}</td>
            <td>${rec.section}</td>
            <td>${isNaN(rec.score) ? "-" : rec.score}</td>
            <td><button class="download-btn">Download PDF</button></td>
          `;

          const btn = tr.querySelector("button");
          btn.addEventListener("click", () => buildPDF(rec));

          tbody.appendChild(tr);
          allRows.push(tr);
        });

        table.appendChild(tbody);
        tableWrap.appendChild(table);
        inner.appendChild(tableWrap);
        sectionBlock.appendChild(inner);
        sectionAccordion.appendChild(sectionBlock);
      });

      courseBlock.appendChild(sectionAccordion);
      dataContainer.appendChild(courseBlock);
    });

    rowCountEl.textContent = allRows.length.toString();
  }

  function applySearchFilter(query) {
    const q = sanitize(query);
    const hasQuery = q.length > 0;

    allRows.forEach((tr) => {
      if (!hasQuery) {
        tr.classList.remove("hidden");
        return;
      }
      const hay =
        tr.dataset.name + " " +
        tr.dataset.course + " " +
        tr.dataset.section;
      tr.classList.toggle("hidden", !hay.includes(q));
    });
  }

  searchInput.addEventListener("input", (e) => {
    applySearchFilter(e.target.value || "");
  });

  console.log("[DEBUG] Script running, loading data via collectionGroupâ€¦");
  loadData();
</script>
</body>
</html>
