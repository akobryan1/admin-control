<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Final Exam Results Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Cache busting -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --border-soft: #1f2937;
      --accent: #22d3ee;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f87171;
      --radius-lg: 16px;
    }
    body {
      margin:0;
      font-family: system-ui, sans-serif;
      background:#0b1120;
      color:var(--text);
    }
    .page { max-width:1100px; margin:0 auto; padding:20px; }
    h1 { margin:0 0 10px; }

    .toolbar { display:flex; gap:12px; margin:20px 0; }
    .search-wrap { flex:1; position:relative; }
    .search-wrap input {
      width:100%; padding:9px 32px; border-radius:999px;
      border:1px solid var(--border-soft);
      background:#0f172a; color:white;
    }
    .card {
      padding:15px;
      background:#0f172a;
      border-radius:var(--radius-lg);
      border:1px solid #1e293b;
    }

    .status-bar { font-size:0.85rem; display:flex; justify-content:space-between; color:var(--muted); }

    table {
      width:100%; border-collapse:collapse; margin-top:10px;
    }
    th, td {
      padding:8px 10px; border-bottom:1px solid #1e293b;
      white-space:nowrap;
    }
    th { background:#1e293b; position:sticky; top:0; }
    tr:nth-child(even){ background:#0d1b2a; }
    tr:nth-child(odd){ background:#102136; }

    button.pdf-btn {
      background:#22d3ee;
      border:none;
      padding:5px 10px;
      border-radius:6px;
      cursor:pointer;
      color:black;
      font-weight:600;
    }
  </style>
</head>

<body>
<div class="page">

  <h1>Final Exam Submissions — ANSCI</h1>

  <div class="toolbar">
    <div class="search-wrap">
      <input id="searchInput" type="text" placeholder="Search name, course, section…" />
    </div>
    <div style="font-size:0.9rem;">
      Loaded rows: <strong id="rowCount">0</strong>
    </div>
  </div>

  <div class="card">
    <div class="status-bar">
      <div id="statusText">Loading Firestore…</div>
      <div id="lastUpdated">Last updated: —</div>
    </div>

    <div class="table-wrap">
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Course</th>
            <th>Section</th>
            <th>Score</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
    authDomain: "kuya-quiz-100.firebaseapp.com",
    projectId: "kuya-quiz-100",
    storageBucket: "kuya-quiz-100.firebasestorage.app",
    messagingSenderId: "74623975270",
    appId: "1:74623975270:web:dec2b21dbee017292952a7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ANSCI_DOC = "ANSCI2025Final";

  const resultsBody = document.getElementById("resultsBody");
  const rowCountEl = document.getElementById("rowCount");
  const statusText = document.getElementById("statusText");
  const lastUpdated = document.getElementById("lastUpdated");
  const searchInput = document.getElementById("searchInput");

  let ALL_ROWS = [];

  function setStatus(msg){ statusText.textContent = msg; }

  async function loadData() {
    setStatus("Loading...");

    const subsRef = collection(db, "finals-exam", ANSCI_DOC, "submissions");
    const snap = await getDocs(subsRef);

    const records = [];

    for (const d of snap.docs) {
      const data = d.data();
      records.push({
        id: d.id,
        name: data.Name ?? "Unknown",
        course: data.Course ?? "Unknown",
        section: data.Section ?? "—",
        score: data.Score ?? 0
      });
    }

    ALL_ROWS = records;
    renderTable(records);
    setStatus("Loaded.");
    lastUpdated.textContent = "Last updated: " + new Date().toLocaleString();
  }

  function renderTable(rows) {
    resultsBody.innerHTML = "";
    rowCountEl.textContent = rows.length;

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.dataset.name = r.name.toLowerCase();
      tr.dataset.course = r.course.toLowerCase();
      tr.dataset.section = r.section.toLowerCase();

      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.course}</td>
        <td>${r.section}</td>
        <td>${r.score}</td>
        <td><button class="pdf-btn" data-id="${r.id}">PDF</button></td>
      `;
      resultsBody.appendChild(tr);
    });
  }

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const filtered = ALL_ROWS.filter(r =>
      r.name.toLowerCase().includes(q) ||
      r.course.toLowerCase().includes(q) ||
      r.section.toLowerCase().includes(q)
    );
    renderTable(filtered);
  });

  // PDF generation
  document.body.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("pdf-btn")) return;

    const id = e.target.dataset.id;

    const ref = doc(db, "finals-exam", ANSCI_DOC, "submissions", id);
    const snap = await getDoc(ref);
    const data = snap.data();

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    pdf.setFontSize(14);
    pdf.text("Student Answer Sheet", 14, 15);

    pdf.setFontSize(11);
    let y = 28;

    function add(text){
      pdf.text(text, 14, y);
      y += 7;
    }

    add("Name: " + (data.Name ?? "Unknown"));
    add("Course: " + (data.Course ?? "Unknown"));
    add("Section: " + (data.Section ?? "—"));
    add("Score: " + (data.Score ?? "0"));
    y += 5;
    add("Answers:");

    const answers = data.answers ?? [];

    answers.forEach((item, i) => {
      add(`Q${i+1}: chosen=${item.chosenAnswer}, correct=${item.correctAnswer}, isCorrect=${item.isCorrect}`);
      Object.entries(item.options).forEach(([key, val]) => {
        add(`    ${key}: ${val}`);
      });
      y += 2;
    });

    pdf.save(`${data.Name}-ANS-${id}.pdf`);
  });

  loadData();
</script>
</body>
</html>
